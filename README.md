# JEGP CMake Modules

CMake modules that abstract common functionality in the JEGP libraries.

## Variables

This repository reserves
CMake identifiers and
filenames in binary directories
that begin with `JEGP_` and `_JEGP_` regardless of case
or equal to the name of a JEGP CMake module.

### Variables that Change Behavior

- `JEGP_CPPFRONT_INCLUDE_DIRECTORIES`:
List of preprocessor include file search directories
for Cpp1 source files generated by `cppfront`.

- `JEGP_CXX_HEADER_FILE_EXTENSIONS`:
List of extensions for C++ header files.

- `JEGP_CXX_MODULES_BINARY_PARENT_DIR`:
Parent binary directory
of the modules built for the current configuration.
Currently required to enable use of imported modules.

- `JEGP_CXX_MODULES_SYSTEM_CACHE`:
Cache path of the system's C++ modules.

- `JEGP_CXX2_COMPILER`:
The full path to the compiler for Cpp2.

- `JEGP_<PROJECT-NAME>_NAME_PREFIX`:
Prefix of names added by some of these modules.
When not defined, `${PROJECT_NAME}_` is prefixed.
_Base name_ refers to the unprefixed added name.

### Variables for Languages

- `JEGP_CXX2_FLAGS`:
Cpp2 flags.
The semantics are those of [`CMAKE_<LANG>_FLAGS`][].

## Modules

### Project Modules

#### `JEGPAddModule`

This module defines the following functions.

```
jegp_add_module(<name>
                [IMPORTABLE_HEADER]
                [SOURCES <source>...]
                [COMPILE_OPTIONS <option>...]
                [LINK_LIBRARIES <library>...])
```

This function adds the object library `${name}`.
The meaning of the keywords other than `IMPORTABLE_HEADER`
are the same as for [`jegp_add_test`][],
except that `PRIVATE` is not implied.
At last, it calls `jegp_cpp_module` with
`${name}` and forwards `IMPORTABLE_HEADER`.

```
jegp_cpp_module(<target>
                [IMPORTABLE_HEADER |
                 MODULE_INTERFACE_UNIT <source>])
```

This function enables the object library `${target}` to compile as a C++
module (default) or
importable header (when `IMPORTABLE_HEADER` is specified).

##### Limitations

- The generally supported [`CMAKE_CXX_COMPILER_ID`][]s are `Clang` and `GNU`.
  The keyword `IMPORTABLE_HEADER` is supported with `GNU`.
- The generally supported [`CMAKE_GENERATOR`][]s are `Ninja` and `Unix Makefiles`.
  `Ninja` + `GNU` `CMAKE_CXX_COMPILER_ID` is blocked on https://github.com/ninja-build/ninja/issues/1962,
  and the dependency scanner does not work with `Ninja`.
- Only single source file modules are supported.
  At the call of `jegp_cpp_module`,
  either `MODULE_INTERFACE_UNIT` should be specified, or
  the target's [`SOURCES` property][] must have
  only one C++ source outside a generator expression,
  whichever must represent its [module interface unit][].
- Bundled is a regex-based module dependency scanner.
  Because it runs as a [deferred call][] in [`CMAKE_SOURCE_DIR`][],
  imported modules need to be visible in this directory.
  Because it is bundled in this CMake module,
  for dependent projects that do not use this CMake module to benefit from it,
  the config file must include this CMake module.
- No support for installing the added target.

#### `JEGPTargetLinkHeaderUnits`

This module defines the following function.

```
jegp_target_link_header_units(<target> <header>...)
```

This function specifies header units to use
when linking `${target}` and/or its dependents.

##### Limitations

Only supported for `GNU` as the [`CMAKE_CXX_COMPILER_ID`][].
And then, only for system headers.

#### `JEGPCpp2`

This module defines the following function.

```
jegp_cpp2_target(<target>)
```

This function enables the target to compile its Cpp2 source files.

The target's `SOURCES` property is inspected for Cpp2 source files.
Corresponding Cpp1 source files are generated and added as sources to the target.

#### `JEGPProjectModules`

This module includes all project modules.

### Test Modules

#### `JEGPHeadersTest`

This module defines the following function.

```
jegp_add_headers_test(<target>...
                      [PRIVATE_REGEXES <regex>...])
```

This function enforces [SF.11]
on the public headers of the targets.
The headers are determined from
the `INTERFACE_INCLUDE_DIRECTORIES` property of the targets and
the `JEGP_CXX_HEADER_FILE_EXTENSIONS` variable,
excluding headers that [match][] any `PRIVATE_REGEXES`.

A target _`T`_ with base name `headers_test` is added.
When _`T`_ builds, the public headers are self-contained.
Invocations that share _`T`_ append headers to the build of _`T`_.

[ _Example:_
```CMake
add_library(mylib src/a.cpp)
target_include_directories(mylib PUBLIC src/)
jegp_add_headers_test(mylib PRIVATE_REGEXES "detail/;external/")
```
-- _end example_ ]

#### `JEGPAddHeaderTest`

This module defines the following function.

```
jegp_add_header_test()
```

This function enforces [SF.11]
for the public headers of the JEGP library `${PROJECT_NAME}`.
It adds an executable target that builds when the headers are self-contained.
Otherwise, a build error should give a clue about the problematic headers.

The target's base name is `test_headers`.
`${PROJECT_NAME}` is a `PRIVATE` linked library of the target.
The public headers of `${PROJECT_NAME}` are those ending in `.hpp`
in the directory `${${PROJECT_NAME}_SOURCE_DIR}/include`.

#### `JEGPAddTest`

This module defines the following function.

```
jegp_add_test(<name>
              [TYPE {EXECUTABLE | OBJECT_LIBRARY}]
              [SOURCES <source>...]
              [COMPILE_OPTIONS <option>...]
              [LINK_LIBRARIES <library>...])
```

This function adds the target `${name}`.
- `TYPE` specifies the type of the added target and defaults to `EXECUTABLE`. \
  [ _Note:_ An `OBJECT_LIBRARY` target effectively serves as compile-time test. -- _end note_ ]
- `SOURCES` specifies its source files in `${CMAKE_CURRENT_SOURCE_DIR}`.
  Defaults to `${name}.cpp`.
- `COMPILE_OPTIONS` specifies its `PRIVATE` compile options.
- `LINK_LIBRARIES` specifies its `PRIVATE` linked libraries.

#### `JEGPBuildError`

This module defines the following function.

```
jegp_add_build_error(<name>
                     [AS {TEST | BUILD_CHECK}]
                     [TYPE {OBJECT_LIBRARY | EXECUTABLE}]
                     [SOURCE <source>]
                     [COMPILE_OPTIONS <option>...]
                     [LINK_LIBRARIES <library>...])
```

This function permits checking that building the source fails with specified error messages.
The check is done as a test by default; it can also be done at build-time, according to `AS`.
The meaning of the other keywords can be inferred from [`jegp_add_test`][],
except that `TYPE` defaults to `OBJECT_LIBRARY`.

The error message specifiers are in the source in their expected order of appearance in the build output.
They [match][] the regex ` *// *error(-regex)?: *([^\n]*) *`.
The build output contains or matches `\2` depending on whether `\1` matched.
A copy of the source without the error message specifiers is built for the check.

_Note:_ `AS BUILD_CHECK` has the limitations of [`CMAKE_EXPORT_COMPILE_COMMANDS`][].

#### `JEGPTestUtilities`

This module includes all test modules.


[`jegp_add_test`]: #jegpaddtest

[SF.11]: http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rs-contained
"Header files should be self-contained"

[match]: https://cmake.org/cmake/help/latest/command/string.html#regex-match

[`CMAKE_EXPORT_COMPILE_COMMANDS`]: https://cmake.org/cmake/help/latest/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html

[module interface unit]: https://eel.is/c++draft/module#def:module_interface_unit

[deferred call]: https://cmake.org/cmake/help/latest/command/cmake_language.html#deferring-calls

[`CMAKE_CXX_COMPILER_ID`]: https://cmake.org/cmake/help/latest/variable/CMAKE_LANG_COMPILER_ID.html

[`CMAKE_GENERATOR`]: https://cmake.org/cmake/help/latest/variable/CMAKE_GENERATOR.html

[`CMAKE_SOURCE_DIR`]: https://cmake.org/cmake/help/latest/variable/CMAKE_SOURCE_DIR.html

[`CMAKE_<LANG>_FLAGS`]: https://cmake.org/cmake/help/latest/variable/CMAKE_LANG_FLAGS.html

[`SOURCES` property]: https://cmake.org/cmake/help/latest/prop_tgt/SOURCES.html
